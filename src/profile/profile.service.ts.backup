import { Injectable, NotFoundException } from '@nestjs/common';
import { SupabaseService } from '../services/supabase.service';
import { ProfileUpdateDto } from './profile.types';

@Injectable()
export class ProfileService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getUserProfile(userId: string): Promise<any> {
    try {
      // ใช้ getUserById จาก SupabaseService ที่มีอยู่แล้ว
      const profile: any = await this.supabaseService.getUserById(
        parseInt(userId, 10),
      );

      if (!profile) {
        throw new NotFoundException('User profile not found');
      }

      return profile;
    } catch (error: any) {
      console.error('Database error:', error);
      throw new NotFoundException('User profile not found');
    }
  }

  async updateUserProfile(
    userId: string,
    updateData: ProfileUpdateDto,
  ): Promise<any> {
    try {
      console.log('Updating user profile in database:', {
        userId,
        updateData,
      } as any);

      // ใช้ updateUser จาก SupabaseService ที่มีอยู่แล้ว
      const updatedProfile = await this.supabaseService.updateUser(
        parseInt(userId, 10),
        {
          ...updateData,
          updated_at: new Date().toISOString(),
        },
      );

      if (!updatedProfile) {
        throw new NotFoundException('Failed to update user profile');
      }

      console.log('Profile updated successfully:', updatedProfile);
      return updatedProfile;
    } catch (error: any) {
      console.error('Database update error:', error);
      throw new NotFoundException('Failed to update user profile');
    }
  }
}
