version: '3.8'

services:
  # Staging API Service
  api:
    image: ${DOCKER_REGISTRY:-your-registry.com}/vita-wise-api:${IMAGE_TAG:-latest}
    container_name: vita-wise-api-staging
    ports:
      - '8081:8080'
    environment:
      - NODE_ENV=staging
      - PORT=8080
      - LOG_LEVEL=debug
    env_file:
      - .env.staging
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'node', 'dist/health-check.js']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - vita-wise-staging-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Staging Database (if needed)
  postgres-staging:
    image: postgres:15-alpine
    container_name: vita-wise-postgres-staging
    environment:
      - POSTGRES_DB=vitawise_staging
      - POSTGRES_USER=vitawise
      - POSTGRES_PASSWORD=staging_password
    ports:
      - '5433:5432'
    volumes:
      - postgres_staging_data:/var/lib/postgresql/data
    networks:
      - vita-wise-staging-network
    profiles:
      - database

  # Staging Redis (if needed)
  redis-staging:
    image: redis:7-alpine
    container_name: vita-wise-redis-staging
    ports:
      - '6380:6379'
    volumes:
      - redis_staging_data:/data
    networks:
      - vita-wise-staging-network
    profiles:
      - cache

networks:
  vita-wise-staging-network:
    driver: bridge

volumes:
  postgres_staging_data:
    driver: local
  redis_staging_data:
    driver: local
